<html>
  <head>
    <link rel="stylesheet" type="text/css" href="res/style.css" />
    <link rel="stylesheet" type="text/css" href="res/itempopup.css" />
    <link rel="stylesheet" type="text/css" href="res/poedit.css" />
    <link rel="stylesheet" type="text/css" href="res/jquery-ui.min.css" />
    <link rel="stylesheet" type="text/css" href="res/jquery-ui.structure.min.css" />
    <link rel="stylesheet" type="text/css" href="res/jquery-ui.theme.min.css" />

    <script>if (typeof module === 'object') {
        window.module = module;
        module = undefined;
      }</script>

    <script src="res/jquery-3.3.1.min.js"></script>
    <script src="res/jquery.lazy.js"></script>
    <script src="res/jquery-ui.js"></script>
    <script src="res/utils.js"></script>
    <script src="res/itempopup.js"></script>
    <script src="res/page-utils.js"></script>
    <script src="res/jquery.tablesorter.js"></script>
    <script src="res/jquery.tablesorter.widgets.js"></script>
    
    <!-- Insert this line after script imports -->
    <script>if (window.module)
        module = window.module;</script>
    <script>

      const RunParser = require('./modules/RunParser');
      const settings = require('./modules/settings').get();
      const logger = require('./modules/Log').getLogger(__filename);
      const DB = require('./modules/DB').getDB();
      const {ipcRenderer, remote} = require('electron');
      const StatsGetter = require('./modules/StatsGetter');
      const ItemData = require('./modules/ItemData');
      const Utils = require('./modules/Utils');
      const moment = require('moment');
      const GearChecker = require('./modules/GearChecker');
      
      $(document).ready(async () => {
        
        $("#sidenav").load("sidenav.html", () => {
          //$("#sidenav-items").append("<div><a class='ui-text' onclick='screenshot()'>Screenshot</a></div>");
        });
        $("#messages").load("messages.html");
        
//        GearChecker.fixGearDiffs();
        
        var gear = await new Promise( (resolve, reject) => {
          DB.all(`select timestamp, diff from gear order by 1 desc limit 120 `, async (err, rows) => {
            resolve(rows);
          });
        });
        
        console.log(gear);
        
        for(let i = 0; i < gear.length; i++) {
          let diff = JSON.parse(gear[i].diff);
          display(gear[i].timestamp, diff);
        }
        
      });
      
      function display(timestamp, diff) {
        a(timestamp);
        let keys = Object.keys(diff);
        keys.forEach(key => {
          let d = diff[key];
          if(d.prev && d.curr) {
            if(!d.prev.length && !d.curr.length) {
              let itemsEqual = GearChecker.itemsEqual(d.prev, d.curr);
              if(!itemsEqual) {
                a(key);
                displayItem(d.prev);
                displayItem(d.curr);
              } else {
                a("SAIME");
              }
            }
          }
        })
      }
      
      function displayItem(item) {
        if(!item) {
          a("Null");
        } else {
          let g = $("#gearContainer");
          let div = createPopup(item);
          g.append(div);
        }
      }
      
      function a(s) {
        let g = $("#gearContainer");
        g.append($(`<div>${s}</div>`));
      }

    </script>
    
  </head>
  <body style='overflow-x: hidden;'>
    
    <div id="popupContainer" style="pointer-events:none;display:none;height:100%;width:100%;z-index:999;position:absolute;top:0;left:0"></div>
    
    <div id="outerDiv">
    
      <div class='sidenav' id='sidenav'></div>
      
      <div id="gearContainer">
      </div>

      <div class="footer">
        Generated by Exile Diary v<span id='appVersionFooter'></span> https://github.com/briansd9/exile-diary
        <script>
          $("#appVersionFooter").html(require('electron').remote.app.getVersion());
        </script>      
      </div>
      <div id="messagePadding" style="height:150px;visibility:hidden;">&nbsp;</div>
      <div id="messages" class="messageSection"></div>
      
    </div>
  </body>
</html>